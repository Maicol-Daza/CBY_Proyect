<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Ajustes y Acciones</title>
  <style>
    .contenedor-ajustes {
      display: flex;
      gap: 50px;
      margin-top: 20px;
    }
    .columna {
      flex: 1;
    }
    .columna h3 {
      margin-bottom: 10px;
    }
    .grupo-ajuste {
      margin-bottom: 20px;
    }
    .grupo-ajuste h4 {
      margin: 10px 0 5px 0;
    }
    table {
      width: 100%;
      margin-top: 30px;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    th {
      background: #f4f4f4;
    }
  </style>
</head>
<body>
  <h1>Selecciona Ajustes</h1>

  <div class="contenedor-ajustes">
    <div class="columna" id="columnaAjustes">
      <h3>Ajustes</h3>
    </div>

    <div class="columna" id="columnaAcciones">
      <h3>Acciones</h3>
    </div>
  </div>

  <button id="guardarCombinacion">Guardar combinación</button>

  <!-- Tabla para mostrar combinaciones -->
  <h2>Combinaciones guardadas</h2>
  <table id="tablaCombinaciones">
    <thead>
      <tr>
        <th>Ajuste</th>
        <th>Acción</th>
      </tr>
    </thead>
    <tbody>
      <!-- Aquí se insertan dinámicamente -->
    </tbody>
  </table>

  <script>
    async function cargarAjustes() {
      try {
        const res = await fetch("http://localhost:3000/api/ajustes");
        const ajustes = await res.json();

        const columnaAjustes = document.getElementById("columnaAjustes");
        const columnaAcciones = document.getElementById("columnaAcciones");
        const tablaBody = document.querySelector("#tablaCombinaciones tbody");

        // Ajustes (con check en cada ajuste)
        ajustes.forEach(ajuste => {
          const div = document.createElement("div");
          div.classList.add("grupo-ajuste");

          const label = document.createElement("label");
          label.innerHTML = `
            <input type="checkbox" name="ajuste" value="${ajuste.id_ajuste}">
            ${ajuste.nombre_ajuste}
          `;

          div.appendChild(label);
          columnaAjustes.appendChild(div);
        });

        // Acciones (únicas)
        const todasAcciones = new Map();
        ajustes.forEach(ajuste => {
          ajuste.acciones.forEach(acc => {
            todasAcciones.set(acc.id_accion, acc);
          });
        });

        todasAcciones.forEach(acc => {
          const precio = Number(acc.precio);
          const label = document.createElement("label");
          label.innerHTML = `
            <input type="checkbox" name="accion" value="${acc.id_accion}">
            ${acc.nombre_accion} ($${isNaN(precio) ? '0.00' : precio.toFixed(2)})
          `;
          columnaAcciones.appendChild(label);
          columnaAcciones.appendChild(document.createElement("br"));
        });

        // Función para refrescar la tabla
        function mostrarCombinaciones() {
          tablaBody.innerHTML = "";
          const combinaciones = JSON.parse(localStorage.getItem("combinaciones")) || [];
          combinaciones.forEach(c => {
            const fila = document.createElement("tr");
            fila.innerHTML = `
              <td>${c.ajusteNombre}</td>
              <td>${c.accionNombre}</td>
            `;
            tablaBody.appendChild(fila);
          });
        }

        // Cargar lo que ya estaba guardado
        mostrarCombinaciones();

        // Guardar combinaciones nuevas
        document.getElementById("guardarCombinacion").addEventListener("click", () => {
          const seleccionAjustes = [...document.querySelectorAll('input[name="ajuste"]:checked')];
          const seleccionAcciones = [...document.querySelectorAll('input[name="accion"]:checked')];

          if (seleccionAjustes.length === 0 || seleccionAcciones.length === 0) {
            alert("Debes seleccionar al menos un ajuste y una acción.");
            return;
          }

          const nuevasCombinaciones = [];
          seleccionAjustes.forEach(ajuste => {
            seleccionAcciones.forEach(accion => {
              nuevasCombinaciones.push({
                ajusteId: ajuste.value,
                ajusteNombre: ajuste.parentElement.textContent.trim(),
                accionId: accion.value,
                accionNombre: accion.parentElement.textContent.trim()
              });
            });
          });

          let combinaciones = JSON.parse(localStorage.getItem("combinaciones")) || [];
          combinaciones = [...combinaciones, ...nuevasCombinaciones];
          localStorage.setItem("combinaciones", JSON.stringify(combinaciones));

          mostrarCombinaciones();
        });

      } catch (err) {
        console.error("Error cargando ajustes:", err);
      }
    }

    cargarAjustes();
  </script>
</body>
</html>
